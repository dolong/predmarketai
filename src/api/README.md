# Agent Runner API

This directory contains the backend services for the AI Automation Dashboard.

## Agent Runner Service

The `agentRunner.ts` file provides a centralized service for executing AI agents to generate questions. This service is designed to be used by both the frontend UI and backend cron jobs.

### Features

- **Unified API**: Single service for executing agents from any context
- **Flexible Response Handling**: Automatically uses fields from API responses when available
- **Error Handling**: Comprehensive error handling with detailed error messages
- **Batch Execution**: Run multiple agents in sequence
- **Frequency Filtering**: Execute agents based on their schedule frequency
- **Logging**: Built-in console logging for debugging and monitoring

### Usage

#### Running a Single Agent (Frontend)

```typescript
import { AgentRunner } from '../api/agentRunner';

// Run an agent and get the generated question
const result = await AgentRunner.runAgent(agent);

if (result.success && result.question) {
  console.log('Generated question:', result.question.title);
  // Add question to your state, database, etc.
} else {
  console.error('Failed to run agent:', result.error);
}
```

#### Running Multiple Agents

```typescript
import { AgentRunner } from '../api/agentRunner';

// Run all active agents
const results = await AgentRunner.runAgents(agents);

// Check results
const successful = results.filter(r => r.success).length;
console.log(`${successful} agents executed successfully`);
```

#### Running Agents by Frequency (Cron Jobs)

```typescript
import { AgentRunner } from '../api/agentRunner';

// Run only daily agents
const results = await AgentRunner.runAgentsByFrequency(agents, 'daily');

// Or weekly agents
const weeklyResults = await AgentRunner.runAgentsByFrequency(agents, 'weekly');
```

### API Response Format

The Agent Runner expects the agent's API endpoint to return a JSON response with the following fields:

#### Required Fields

- `question` (string): The generated question text

#### Optional Fields

All optional fields will be used if provided by the API. If not provided, sensible defaults are used:

- `description` (string): Question description. Default: "Generated by {agent.name}"
- `liveDate` (string|Date): When the question goes live. Default: 1 hour from now
- `answerEndAt` (string|Date): When voting closes. Default: 24 hours from now
- `settlementAt` (string|Date): When the question is resolved. Default: 1 hour after answerEndAt
- `resolutionCriteria` (string): How to resolve the question. Default: agent's resolutionPrompt
- `aiScore` (number): Confidence score (0-1). Default: 1.0
- `type` ('binary' | 'multi-option'): Question type. Default: 'binary'
- `categories` (string[]): Question categories. Default: [agent.category] if available
- `riskFlags` (string[]): Risk warnings. Default: []

#### Example API Response

```json
{
  "question": "Will Bitcoin reach $100,000 by the end of 2024?",
  "description": "This question tracks whether Bitcoin (BTC) will reach or exceed $100,000 USD by December 31, 2024.",
  "liveDate": "2024-01-15T09:00:00Z",
  "answerEndAt": "2024-12-31T23:59:59Z",
  "settlementAt": "2025-01-01T12:00:00Z",
  "resolutionCriteria": "Resolved YES if Bitcoin closes at or above $100,000 on any exchange by 11:59 PM UTC on December 31, 2024.",
  "aiScore": 0.95,
  "type": "binary",
  "categories": ["Cryptocurrency", "Finance"],
  "riskFlags": []
}
```

### Cron Job Setup

A sample cron job script is provided at `src/scripts/runAgentsCron.ts`. To schedule it:

1. **Daily Agents** (every day at 9 AM):
   ```bash
   0 9 * * * node /path/to/dist/scripts/runAgentsCron.js daily
   ```

2. **Weekly Agents** (every Monday at 10 AM):
   ```bash
   0 10 * * 1 node /path/to/dist/scripts/runAgentsCron.js weekly
   ```

3. **All Active Agents** (every 6 hours):
   ```bash
   0 */6 * * * node /path/to/dist/scripts/runAgentsCron.js
   ```

### Error Handling

The Agent Runner returns a result object with a `success` flag and either a `question` or `error`:

```typescript
interface AgentRunResult {
  success: boolean;
  question?: ProposedQuestion;
  error?: string;
}
```

Common errors:
- "No API endpoint configured for this agent" - Agent has no API source
- "API returned empty response" - API endpoint returned no data
- "API returned invalid JSON" - API response is not valid JSON
- "API response missing required 'question' field" - Response doesn't have the question text

### Logging

The Agent Runner includes comprehensive logging:

- Agent execution start/end
- API endpoint being called
- Generated question details
- Error messages with context

Logs are output to the console and can be captured by your logging infrastructure.

### Database Integration

Currently, the service creates ProposedQuestion objects but doesn't automatically save them to the database. To enable database persistence, uncomment this line in `agentRunner.ts`:

```typescript
// await proposedQuestionsApi.createProposedQuestion(proposedQuestion);
```

This will automatically save all generated questions to the `proposed_questions` table.

### Future Enhancements

- **Retry Logic**: Automatically retry failed API calls
- **Rate Limiting**: Prevent overwhelming external APIs
- **Webhooks**: Notify external systems when questions are generated
- **Analytics**: Track agent performance and success rates
- **A/B Testing**: Test different prompts for the same agent
